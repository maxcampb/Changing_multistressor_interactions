---
title: "Data analysis"
output: html_document
---


```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)

```





```{r}

library(tidyr)
library(readxl)
library(dplyr)
library(ggplot2)
library(brms)
library(visreg)
library(patchwork)

```


## Read in data 

```{r}

files <- list.files(path = "../Data",pattern = "DIN_light_rep", full.names = TRUE)
xdin_light <- lapply(files, function(x) read.csv(x)) %>%
  bind_rows(.id = "id") %>% within(hours[hours == 0.3] <- 0.33)

# # Check that absorbances are different
# na.omit(read.csv(files[[1]])$Absorbance == read.csv(files[[3]])$Absorbance)

files <- list.files(path = "../Data", pattern = "diuron_light_rep", full.names = TRUE)

xdiuron_light <- lapply(files, function(x) read.csv(x)) %>%
  bind_rows(.id = "id") %>% within(hours[hours == 0.3] <- 0.33)

```

## Data processing and summarizing 

Let's just look at the averages 

Diuron and light 

```{r}

xdiuron_light2 <- xdiuron_light  %>% 
  filter(Replicate == "AVERAGE", Diuron != "Blank", hours >= 0) %>%
  group_by(hours, Light, Diuron, id) %>% 
  summarise(Absorbance = mean(Absorbance), X = paste(X, collapse = " ")) %>% ungroup() %>% 
  within({
    
    Diuron_num <-  case_when(Diuron == "AlgaeControl" ~ 0,
                             Diuron == "MeOH" ~ 0,
                             TRUE ~ as.numeric(Diuron)
                             )
    
    Light_num <-  as.numeric(Light)
  
    block <-  factor(id)
    
    hours_fact <- factor(hours)
    
    celld <- 4179.6 * Absorbance - 172.48
    t0 <- ifelse(hours == 0, celld, NA)
    
    }) %>% group_by(Light, Diuron, id ) %>% fill(t0) %>% 
  ungroup() %>%  
  mutate(sample_id = factor(gsub("."," ", x = paste(Diuron, Light, block), fixed = TRUE))) %>% 
  filter(hours != 0, Diuron != "MeOH") %>% 
  mutate(Diuron_fact = factor(ifelse(Diuron == "AlgaeControl", "0", Diuron)))
  

```


# Analysis of Diuron and light 


Fits same model as above but with Diuron instead of DIN. Residuals look a bit skewif if we include block 1. Better if we exclude block 1, check later. 

```{r}

xdiuron_light2 <- xdiuron_light2 %>% filter(block != "1")
m1_diuron_light <- brm(log(celld) ~ 0 + #s(hours, k = 5) + 
                         offset(log(t0)) +
                         Diuron_fact* Light+
                      s(hours, 
                        by = interaction(Diuron_fact, Light),
                        k = 5) +  
                        (1|sample_id)+
                      (1|block), 
                    data = xdiuron_light2,
                    cores = 4)

```


Everythign matters here, include block. 

```{r}
summary(m1_diuron_light)
```

74% of variance is explained. 


Model fit for celld by time

```{r}
pdl <- xdiuron_light2 %>%
  select(Diuron_fact, Light, hours) %>%
  distinct() %>%
  mutate(t0 = 35)
preds <- posterior_epred(m1_diuron_light,
                         re_formula = NA,
                         newdata = pdl)
datp <- cbind(pdl, 
              t(apply(preds, 2, quantile, c(0.025, 0.5, 0.975)))) #%>%
  # filter(Diuron_num %in% c(0, 1, 3))

ggplot(datp) + 
  aes(x = hours, y = `50%`, color = Light,
      fill= Light,
      group = Light) + 
  geom_line() +
  geom_ribbon(aes(ymin = `2.5%`, ymax = `97.5%`), alpha = 0.5, color = NA)+
  facet_wrap(~Diuron_fact)
```



### Diuron IR plots

```{r}

diuron_bayes <- cbind(pdl,t(posterior_epred(m1_diuron_light, newdata = pdl,
                                            re_formula = NA)))

# Generate the control matrix
diuron_bayes_control <- diuron_bayes %>% filter(Diuron_fact == "0" & 
                                                  Light == "80")
diuron_control_mat <- diuron_bayes_control[ match(diuron_bayes$hours, diuron_bayes_control$hours) ,]


# Generate light only matrix
diuron_bayes_light <- diuron_bayes %>% filter(Diuron_fact == "0")
diuron_light_mat <- diuron_bayes_light[ 
  match(paste(diuron_bayes$hours, diuron_bayes$Light_num), 
        paste(diuron_bayes_light$hours, diuron_bayes_light$Light_num)) ,]

# Generate diuron only matrix
diuron_bayes_diuron <- diuron_bayes %>% filter(Light == "80" )
diuron_mat <- diuron_bayes_diuron[ 
  match(paste(diuron_bayes$hours, diuron_bayes$Diuron_num), 
        paste(diuron_bayes_diuron$hours, diuron_bayes_diuron$Diuron_num)) ,]

# Compute the IR matrix
IR_mat2 <- log((select(diuron_bayes, `1`:`4000`)/select(diuron_control_mat, `1`:`4000`))/
                ((select(diuron_light_mat, `1`:`4000`)/select(diuron_control_mat, `1`:`4000`))*
                   (select(diuron_mat, `1`:`4000`)/select(diuron_control_mat, `1`:`4000`))))


# Compute the credible intervals
Diuron_CItrend3 <- cbind(data.frame(t(apply(IR_mat2, 1, quantile, probs = c(0.025, 0.5, 0.975), na.rm = TRUE))), pdl) %>% within({
  Treatment <- case_when(Light == "80" & Diuron_fact == "0" ~ "Control",
                         Light == "80"  ~ "Diuron_only",
                         Diuron_fact == "0"  ~ "Light_only",
                        TRUE ~ paste0("Light = ", Light, ", Diuron = ", Diuron_fact))}) %>% 
  filter(!(Treatment %in% c("Light_only","Diuron_only",  "Control")))

ggplot(Diuron_CItrend3) + aes(x = hours, y = X50., colour = Treatment, fill = Treatment) + 
  geom_hline(yintercept = 0, lty= "dashed") +
  theme_classic() + 
  xlab("Hours") +
  geom_point(position = position_dodge2(8)) + 
  geom_linerange(mapping = aes(ymin = X2.5., ymax = X97.5.), position = position_dodge2(8)) +
    ylab(expression("I"[R])) + guides(alpha = FALSE)


```

